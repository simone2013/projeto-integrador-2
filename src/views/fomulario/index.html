<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" >
  <link href="style.css" rel="stylesheet">  <title>DoaFacil</title>
    <style>
        body, html {
            height: 100%;
        }
        .container {
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }


    </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #6495ED">
    <a class="navbar-brand me-2" href="../fomulario/index.html">
      <img src="" alt="DoaFacil" style="height: 100px;"> <!-- Ajuste a altura conforme necessário -->
  </a>
  
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link text-dark" href="/pagina-inicial">Home</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-dark" href="/usuarios">Cadastrados</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="../fomulario/usuarios.html">usuarios</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="../fomulario/dashboard.html"> <span>Dashboard</span></a>
        </li>
      </ul>
    </div>
  </nav>
    
    <div class="container">
        <div class="col-4">
                <h2 class="text-center">Seja Bem-Vindo</h2>
                <div class=" mt-5">
                  <form id="searchForm" action="/usuarios" method="get">
                      <div class="input-group mb-3 mt-3">
                          <input type="text" name="name" id="name" class="form-control" placeholder="Cadastrar Doador/Beneficiário" aria-label="Nome" aria-describedby="button-addon2" required>
                          <div class="input-group-append">
                              <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Pesquisar</button>
                          </div>
                      </div>
                  </form>
          
                  <!-- Mensagem de erro (será exibida se o nome não existir) -->
                  <div id="errorMessage" class="alert alert-danger" style="display:none;">
                      O nome não existe. Tente outro.
                  </div>
              </div>
                <div class="text-center">Ou</div>
                <button type="button" class="col-12 btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#exampleModal">
                  Novo Cadastro 
                </button>

                <!-- Modal do Bootstrap -->
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Novo Cadastro</h5>
                      </div>
                      <div class="modal-body">
                        <div class="mb-3 col">
                          <label for="name" class="form-label">Nome</label>
                          <input type="text" class="form-control" id="name" placeholder="">
                        </div>
                        <div class="row">
                          <div class="mb-3 col-5">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" placeholder="">
                          </div>
                          <div class="mb-3 col-3">
                            <label for="birth_date" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="birth_date" placeholder="">
                          </div>
                          <div class="mb-3 col-3">
                            <label for="gender" class="form-label">Sexo</label>
                            <select class="form-select" id="gender">
                              <option value="M">Masculino</option>
                              <option value="F">Feminino</option>
                              <option value="O">Outros</option>
                            </select>
                          </div>
                        </div>
                        <div class="row">
                          <div class="mb-3 col-6">
                            <label for="phone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="phone" placeholder="">
                          </div>
                          <div class="mb-3 col-6">
                            <label for="user_type" class="form-label">Tipo de Usuário</label>
                            <select class="form-select" id="user_type">
                              <option selected>Selecione</option>
                              <option value="donor">Doador</option>
                              <option value="beneficiary">Beneficiário</option>
                            </select>
                          </div>
                        </div>
                        <div class="mb-3 col-12">
                          <label for="street" class="form-label">Rua</label>
                          <input type="text" class="form-control" id="street" placeholder="">
                        </div>
                        <div class="row">
                          <div class="mb-3 col-5">
                            <label for="neighborhood" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="neighborhood" placeholder="">
                          </div>
                          <div class="mb-3 col-5">
                            <label for="complement" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="complement" placeholder="">
                          </div>
                          <div class="mb-3 col">
                            <label for="number" class="form-label">Número</label>
                            <input type="number" class="form-control" id="number" placeholder="">
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" onclick="submitForm()">Salvar alterações</button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content bg-success text-white">
                      <div class="modal-body">
                        <h5 class="modal-title" id="successModalLabel">
                          <i class="fa fa-check-circle"></i> Sucesso!
                        </h5>
                        Cadastro realizado com sucesso!
                      </div>
                    </div>
                  </div>
                </div>
                
          
                <!-- Modal de Erro -->
                <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="errorModalLabel">Erro!</h5>
                      </div>
                      <div class="modal-body">
                        Algo deu errado ao processar seu cadastro.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fechar</button>
                      </div>
                    </div>
                  </div>
                </div>
         
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
       const checkIfNameExists = async (name, accessToken) => {
            try {
                const response = await fetch(`http://localhost:3000/api/users?name=${encodeURIComponent(name)}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                console.log(data.users)
                return data.users.length > 0;
            } catch (error) {
                console.error("Erro ao verificar o nome:", error);
                throw error;
            }
        };

        // Interceptar o envio do formulário
        document.getElementById("searchForm").addEventListener("submit", async function(event) {
            event.preventDefault();  // Impede o envio do formulário tradicional

            const name = document.getElementById("name").value;
            const accessToken = localStorage.getItem('accessToken');  // Certifique-se de que o token de acesso está armazenado corretamente

            try {
                // Verifica se o nome já existe
                const exists = await checkIfNameExists(name, accessToken);

                if (!exists) {
                    // Exibe a mensagem de erro se o nome não existir
                    document.getElementById("errorMessage").style.display = "block";
                } else {
                    // Se o nome existir, envia o formulário normalmente
                    document.getElementById("searchForm").submit();
                }
            } catch (error) {
                console.error("Erro ao verificar o nome:", error);
            }
        });


      const createUser = async (data, accessToken) => {
        try {
          const response = await fetch("http://localhost:3000/api/users", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify(data)
          });
          console.log(response)
          return await response.json();
        } catch (error) {
          console.error("Erro ao criar o usuário:", error);
          throw error;
        }
      };
    
      const getUser = async (userId, accessToken) => {
        try {
          const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${accessToken}`
            }
          });
          return await response.json();
        } catch (error) {
          console.error("Erro ao obter os dados do usuário:", error);
          throw error;
        }
      };

      const submitForm = async () => {
        const data = {
          name: document.getElementById("name").value,
          phone: document.getElementById("phone").value,
          cpf: document.getElementById("cpf").value,
          birth_date: document.getElementById("birth_date").value,
          gender: document.getElementById("gender").value,
          street: document.getElementById("street").value,
          neighborhood: document.getElementById("neighborhood").value,
          complement: document.getElementById("complement").value,
          user_type: document.getElementById("user_type").value,
          number: document.getElementById("number").value,
        };
        console.log(data)
        const accessToken = localStorage.getItem('accessToken');

        try {
          // Cria o usuário
          const responseData = await createUser(data, accessToken);
    
          // Obtém os dados do usuário
          const updatedData = await getUser(responseData.id, accessToken);
    
          // Verifica se os dados foram obtidos corretamente
          if (updatedData) {
            console.log("Usuário atualizado:", updatedData);
            $('#exampleModal').modal('hide');
            $('#successModal').modal('show');
            setTimeout(() => {
      
              window.location.href = 'http://localhost:3000/usuarios';

            }, 2000); // 1 segundo (1000ms)
          } else {
            console.error("Erro: Dados do usuário não encontrados.");
          }
        } catch (error) {
          console.error("Erro no processo de criação ou atualização do usuário:", error);
        }
      };
    </script>
    

  </body>
</html>
